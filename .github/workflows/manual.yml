name: Manual scraper run

on:
  workflow_dispatch:
    inputs:
      which:
        description: Choose shard batch to run
        type: choice
        options:
          - A
          - B
        default: A
      shards_total:
        description: Total number of shards
        type: string
        default: "20"
      shard_split:
        description: Number of shards in batch A
        type: string
        default: "10"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      shards_json: ${{ steps.build-shards.outputs.shards_json }}
      shards_total: ${{ steps.build-shards.outputs.shards_total }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build shards matrix
        id: build-shards
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const which = process.env.WHICH || "A";
          const shardsTotal = Number(process.env.SHARDS_TOTAL || 20);
          const shardSplit = Number(process.env.SHARD_SPLIT || 10);
          const start = which === "B" ? shardSplit + 1 : 1;
          const end = which === "B" ? shardsTotal : shardSplit;

          if (Number.isNaN(shardsTotal) || Number.isNaN(shardSplit)) {
            throw new Error("Invalid shard inputs.");
          }
          if (shardSplit < 1 || shardsTotal < shardSplit) {
            throw new Error("shard_split must be >= 1 and <= shards_total.");
          }
          if (start > shardsTotal) {
            throw new Error("Batch selection exceeds total shards.");
          }

          const shards = [];
          for (let shard = start; shard <= end; shard += 1) {
            shards.push({ shard });
          }

          console.log(`Shard batch ${which}: ${start}..${end} of ${shardsTotal}`);
          const shardsJson = JSON.stringify({ include: shards });
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `shards_json=${shardsJson}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `shards_total=${shardsTotal}\n`);
          NODE
        env:
          WHICH: ${{ inputs.which }}
          SHARDS_TOTAL: ${{ inputs.shards_total }}
          SHARD_SPLIT: ${{ inputs.shard_split }}

  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    needs: prepare
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix: ${{ fromJson(needs.prepare.outputs.shards_json) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Select stores for shard
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const shard = Number(process.env.SHARD);
          const shardsTotal = Number(process.env.SHARDS_TOTAL);
          const stores = JSON.parse(
            fs.readFileSync("data/canadian_tire_stores.json", "utf8")
          ).map(({ storeId, storeName }) => ({
            storeId: String(storeId),
            storeName: String(storeName),
          }));
          const selected = stores.filter((_, index) => (index % shardsTotal) === (shard - 1));

          console.log(`Shard ${shard}/${shardsTotal} selected ${selected.length} stores`);
          for (const store of selected) {
            console.log(`- ${store.storeId} | ${store.storeName}`);
          }

          fs.writeFileSync("stores_for_shard.json", JSON.stringify(selected));
          NODE
        env:
          SHARD: ${{ matrix.shard }}
          SHARDS_TOTAL: ${{ needs.prepare.outputs.shards_total }}

      - name: Run scraper for shard stores
        run: node scraper_ct.js --storesFile stores_for_shard.json

      - name: Upload scraper outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: canadiantire-shard-${{ matrix.shard }}
          path: outputs/
          if-no-files-found: warn

  publish-rebuild-commit:
    runs-on: ubuntu-latest
    needs: scrape
    steps:
      - name: Debug ECONOPLUS secret presence
        run: |
          if [ -z "${{ secrets.ECONOPLUS }}" ]; then
            echo "ECONOPLUS secret is missing."
            exit 1
          fi
          echo "ECONOPLUS secret is present."

      - name: Checkout ECONOPLUS repository
        uses: actions/checkout@v4
        with:
          repository: Olivier-cousineau/econoplus
          token: ${{ secrets.ECONOPLUS }}
          ref: main
          path: econoplus

      - name: Download scraper outputs
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish Canadian Tire data
        run: echo "Publish Canadian Tire data"

      - name: Rebuild Canadian Tire product index
        run: echo "Rebuild Canadian Tire product index"

      - name: Debug artifacts and econoplus content
        run: |
          mkdir -p econoplus/public/canadiantire
          echo "List artifacts contents:"
          find artifacts -maxdepth 4 -print || true
          echo "Find econoplus public/canadiantire:"
          find econoplus/public/canadiantire -print || true

      - name: Sync scraper outputs into ECONOPLUS repo
        run: |
          set -euo pipefail
          mkdir -p econoplus/public/canadiantire

          # Expected layout:
          # artifacts/canadiantire-shard-*/<storeSlug>/{data.json,data.csv}
          mapfile -t store_dirs < <(find artifacts -mindepth 2 -maxdepth 2 -type d -path "artifacts/canadiantire-shard-*/*")

          echo "Found ${#store_dirs[@]} store directories"
          if [ "${#store_dirs[@]}" -eq 0 ]; then
            echo "No store directories found under artifacts/canadiantire-shard-*/<storeSlug>."
            exit 1
          fi

          if command -v rsync >/dev/null 2>&1; then
            for d in "${store_dirs[@]}"; do
              store_slug="$(basename "$d")"
              mkdir -p "econoplus/public/canadiantire/${store_slug}"
              rsync -a "${d}/" "econoplus/public/canadiantire/${store_slug}/"
            done
          else
            for d in "${store_dirs[@]}"; do
              store_slug="$(basename "$d")"
              mkdir -p "econoplus/public/canadiantire/${store_slug}"
              cp -R "${d}/." "econoplus/public/canadiantire/${store_slug}/"
            done
          fi

          echo "Copied files:"
          find econoplus/public/canadiantire -maxdepth 2 -type f -print || true

      - name: Debug ECONOPLUS git status
        working-directory: econoplus
        run: git status --porcelain

      - name: Commit & push
        working-directory: econoplus
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/canadiantire 2>/dev/null || true
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update Canadian Tire (4 stores parallel)"
            git push origin main
          else
            echo "No changes to commit."
          fi
