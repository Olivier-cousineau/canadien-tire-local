name: Manual scraper run

on:
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build matrix from first 4 stores
        id: build-matrix
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const stores = JSON.parse(
            fs.readFileSync("data/canadian_tire_stores.json", "utf8")
          )
            .slice(0, 4)
            .map(({ storeId, storeName }) => ({
              storeId: String(storeId),
              storeName: String(storeName),
            }));

          console.log("Selected stores:");
          for (const store of stores) {
            console.log(`- ${store.storeId} | ${store.storeName}`);
          }

          const matrix = JSON.stringify({ include: stores });
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `matrix=${matrix}\n`);
          NODE

  scrape:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Log selected store
        run: echo "Scraping storeId=${{ matrix.storeId }} storeName=${{ matrix.storeName }}"

      - name: Run scraper
        run: node scraper_ct.js --storeId "${{ matrix.storeId }}" --storeName "${{ matrix.storeName }}"

      - name: Set output paths
        run: |
          CITY_SLUG=$(node -e "const slugify=require('slugify'); console.log(slugify(process.env.STORE_NAME,{lower:true, strict:true}));")
          STORE_SLUG="${STORE_ID}-${CITY_SLUG}"
          OUT_DIR="outputs/canadiantire/${STORE_SLUG}"
          PUBLIC_DIR="public/canadiantire/${STORE_SLUG}"
          echo "CITY_SLUG=$CITY_SLUG" >> $GITHUB_ENV
          echo "STORE_SLUG=$STORE_SLUG" >> $GITHUB_ENV
          echo "OUT_DIR=$OUT_DIR" >> $GITHUB_ENV
          echo "PUBLIC_DIR=$PUBLIC_DIR" >> $GITHUB_ENV
        env:
          STORE_ID: ${{ matrix.storeId }}
          STORE_NAME: ${{ matrix.storeName }}

      - name: Upload scraper outputs
        uses: actions/upload-artifact@v4
        with:
          name: canadiantire-${{ env.STORE_SLUG }}
          path: |
            ${{ env.OUT_DIR }}/
            ${{ env.PUBLIC_DIR }}/
          if-no-files-found: warn

  publish-rebuild-commit:
    runs-on: ubuntu-latest
    needs: scrape
    steps:
      - name: Debug ECONOPLUS secret presence
        run: |
          if [ -z "${{ secrets.ECONOPLUS }}" ]; then
            echo "ECONOPLUS secret is missing."
            exit 1
          fi
          echo "ECONOPLUS secret is present."

      - name: Checkout ECONOPLUS repository
        uses: actions/checkout@v4
        with:
          repository: Olivier-cousineau/econoplus
          token: ${{ secrets.ECONOPLUS }}
          ref: main
          path: econoplus

      - name: Download scraper outputs
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Unzip scraper outputs into repo root
        run: |
          shopt -s nullglob
          for zipfile in artifacts/*.zip; do
            unzip -o "$zipfile" -d staging
          done

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Publish Canadian Tire data
        run: echo "Publish Canadian Tire data"

      - name: Rebuild Canadian Tire product index
        run: echo "Rebuild Canadian Tire product index"

      - name: Sync scraper outputs into ECONOPLUS repo
        run: |
          mkdir -p econoplus/public/canadiantire
          if [ -d "staging/public/canadiantire" ]; then
            cp -R staging/public/canadiantire/. econoplus/public/canadiantire/
          fi

      - name: Commit & push
        working-directory: econoplus
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/canadiantire 2>/dev/null || true
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update Canadian Tire (4 stores parallel)"
            git push origin main
          else
            echo "No changes to commit."
          fi
