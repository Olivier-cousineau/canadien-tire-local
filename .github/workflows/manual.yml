name: Manual scraper run

on:
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      stores_matrix: ${{ steps.build-matrix.outputs.stores_matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build stores matrix
        id: build-matrix
        run: |
          node - <<'NODE'
          const fs = require("fs");

          const raw = JSON.parse(
            fs.readFileSync("data/canadian_tire_stores.json", "utf8")
          );

          const slugify = (input) => {
            return String(input || "")
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "")
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, "-")
              .replace(/^-+|-+$/g, "")
              .replace(/-+/g, "-");
          };

          const stores = raw.slice(0, 4).map((store) => {
            const storeId = String(store.storeId ?? store.id ?? "");
            const storeName = String(store.storeName ?? store.city ?? store.name ?? "");
            const storeSlug = `${storeId}-${slugify(storeName)}`;
            return { storeId, storeName, storeSlug };
          });

          if (!stores.length) {
            throw new Error("Aucun magasin trouvÃ© dans data/canadian_tire_stores.json");
          }

          console.log("Stores matrix:");
          console.log(stores);
          const storesMatrix = JSON.stringify({ include: stores });
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `stores_matrix=${storesMatrix}\n`);
          NODE

  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    needs: prepare
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix: ${{ fromJson(needs.prepare.outputs.stores_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Run scraper for store
        run: node scraper_ct.js --storeId "${{ matrix.storeId }}" --storeName "${{ matrix.storeName }}"

      - name: Publish outputs -> public
        run: |
          set -euo pipefail
          mkdir -p public/canadiantire
          cp -R outputs/canadiantire/* public/canadiantire/

      - name: Debug outputs & public before upload
        run: |
          find outputs -maxdepth 5
          find public -maxdepth 5

      - name: Upload scraper outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: canadiantire-${{ matrix.storeSlug }}
          path: public/canadiantire/**
          if-no-files-found: warn

  publish-to-econoplus:
    runs-on: ubuntu-latest
    needs: scrape
    steps:
      - name: Checkout ECONOPLUS repository
        uses: actions/checkout@v4
        with:
          repository: Olivier-cousineau/econoplus
          token: ${{ secrets.ECONOPLUS }}
          ref: main
          path: econoplus

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: canadiantire-*

      - name: Debug artifact folders
        run: |
          echo "Liste des dossiers sous artifacts/**/public/canadiantire :"
          find artifacts -type d -path "*/public/canadiantire/*" -print || true

      - name: Sync scraper outputs into econoplus repo
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p econoplus/public/canadiantire

          mapfile -t STORE_DIRS < <(find artifacts -mindepth 4 -maxdepth 4 -type d -path "*/public/canadiantire/*" -print | sort)

          echo "Found ${#STORE_DIRS[@]} store folder(s)"
          if [ "${#STORE_DIRS[@]}" -eq 0 ]; then
            echo "::error::No public/canadiantire store folders found in artifacts."
            exit 1
          fi

          for src in "${STORE_DIRS[@]}"; do
            slug="$(basename "$src")"
            dest="econoplus/public/canadiantire/$slug"
            echo "Copy $src -> $dest"
            mkdir -p "$dest"
            if command -v rsync >/dev/null 2>&1; then
              rsync -a "$src"/ "$dest"/
            else
              cp -R "$src"/. "$dest"/
            fi
          done

      - name: Debug ECONOPLUS git status
        working-directory: econoplus
        run: |
          echo "git status --porcelain"
          git status --porcelain

      - name: Commit & push
        working-directory: econoplus
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/canadiantire
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update Canadian Tire stores (4 stores) [skip ci]"
            git push origin HEAD:main
          else
            echo "No changes to commit."
          fi
