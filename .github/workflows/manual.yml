name: Manual scraper run

on:
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build matrix from first 4 stores
        id: build-matrix
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const stores = JSON.parse(
            fs.readFileSync("data/canadian_tire_stores.json", "utf8")
          )
            .slice(0, 4)
            .map(({ storeId, storeName }) => ({
              storeId: String(storeId),
              storeName: String(storeName),
            }));

          console.log("Selected stores:");
          for (const store of stores) {
            console.log(`- ${store.storeId} | ${store.storeName}`);
          }

          const matrix = JSON.stringify(stores);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `matrix=${matrix}\n`);
          NODE

  scrape:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Log selected store
        run: echo "Scraping storeId=${{ matrix.storeId }} storeName=${{ matrix.storeName }}"

      - name: Run scraper
        run: node scraper_ct.js --storeId "${{ matrix.storeId }}" --storeName "${{ matrix.storeName }}"

      - name: Set output paths
        run: |
          CITY_SLUG=$(node -e "const slugify=require('slugify'); console.log(slugify(process.env.STORE_NAME,{lower:true, strict:true}));")
          OUT_DIR="outputs/canadiantire/${STORE_ID}-${CITY_SLUG}"
          echo "CITY_SLUG=$CITY_SLUG" >> $GITHUB_ENV
          echo "OUT_DIR=$OUT_DIR" >> $GITHUB_ENV
        env:
          STORE_ID: ${{ matrix.storeId }}
          STORE_NAME: ${{ matrix.storeName }}

      - name: Upload scraper outputs
        uses: actions/upload-artifact@v4
        with:
          name: canadiantire-${{ matrix.storeId }}-${{ env.CITY_SLUG }}
          path: |
            ${{ env.OUT_DIR }}/data.json
            ${{ env.OUT_DIR }}/data.csv
          if-no-files-found: warn
